<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>稻米分析系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .image-container {
      text-align: center;
      margin-top: 20px;
    }

    .image-container img {
      max-width: 100%;
      height: auto;
    }

    #spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1050;
      display: none;
    }

    .memory-card {
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .memory-card .card-header {
      background-color: #e9ecef;
      border-bottom: 1px solid #dee2e6;
      padding: 0.75rem 1.25rem;
    }

    .memory-info {
      font-size: 0.9rem;
      padding: 0.5rem;
    }

    .memory-value {
      font-weight: 600;
      color: #0d6efd;
    }

    .update-time {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .progress {
      height: 0.5rem;
      margin-top: 0.25rem;
    }

    .memory-label {
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="mt-5">稻米分析系統</h1>

    <!-- 系統資源使用狀況卡片 -->
    <div class="card memory-card mt-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">系統資源使用狀況</h6>
        <span class="update-time" id="last-update-time"></span>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <div class="memory-info">
              <div class="memory-label">
                <strong>實體記憶體 (RSS)</strong>
              </div>
              <span id="current_memory_rss" class="memory-value">載入中...</span> MB
              <div class="progress">
                <div id="rss_progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="memory-info">
              <div class="memory-label">
                <strong>虛擬記憶體 (VMS)</strong>
              </div>
              <span id="current_memory_vms" class="memory-value">載入中...</span> MB
              <div class="progress">
                <div id="vms_progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="memory-info">
              <div class="memory-label">
                <strong>記憶體使用率</strong>
              </div>
              <span id="current_memory_percent" class="memory-value">載入中...</span>%
              <div class="progress">
                <div id="percent_progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <p class="lead">上傳您的稻米圖片以進行分析。</p>

    <form id="upload-form" enctype="multipart/form-data">
      <div class="mb-3">
        <input class="form-control" type="file" id="file" name="file" accept=".jpg,.jpeg,.png" required>
      </div>
      <button type="submit" class="btn btn-primary">上傳並分析</button>
    </form>

    <!-- Spinner -->
    <div id="spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">處理中...</span>
      </div>
    </div>

    <!-- 分析結果模態框 -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="resultModalLabel">分析結果</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <p><strong>預測結果:</strong> <span id="prediction"></span></p>
              <p><strong>處理時間:</strong> <span id="processing_time"></span> 秒</p>
            </div>

            <!-- 記憶體使用資訊卡片 -->
            <div class="card memory-card mb-4">
              <div class="card-header">
                <h6 class="mb-0">處理時記憶體使用狀況</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="memory-info">
                      <strong>實體記憶體 (RSS):</strong><br>
                      <span id="memory_rss" class="memory-value"></span> MB
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="memory-info">
                      <strong>虛擬記憶體 (VMS):</strong><br>
                      <span id="memory_vms" class="memory-value"></span> MB
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="memory-info">
                      <strong>記憶體使用率:</strong><br>
                      <span id="memory_percent" class="memory-value"></span>%
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 圖片輪播 -->
            <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
              <div class="carousel-indicators">
                <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active"
                  aria-current="true" aria-label="原圖"></button>
                <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1"
                  aria-label="去背後的稻穗圖"></button>
              </div>
              <div class="carousel-inner">
                <div class="carousel-item active">
                  <h5 class="text-center">原圖</h5>
                  <img src="#" class="d-block w-100" id="original_image" alt="原圖">
                </div>
                <div class="carousel-item">
                  <h5 class="text-center">去背後的稻穗圖</h5>
                  <img src="#" class="d-block w-100" id="masked_image" alt="去背後的稻穗圖">
                </div>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators"
                data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">上一張</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators"
                data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">下一張</span>
              </button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS 與依賴 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 記憶體使用狀況更新腳本 -->
  <script>
    // 格式化時間
    function formatTime(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const seconds = date.getSeconds().toString().padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    // 更新進度條顏色
    function updateProgressBarColor(percent) {
      if (percent < 50) return 'bg-success';
      if (percent < 75) return 'bg-warning';
      return 'bg-danger';
    }

    // 更新記憶體使用資訊
    async function updateMemoryUsage() {
      try {
        const response = await fetch('/memory');
        if (!response.ok) {
          throw new Error('獲取記憶體資訊失敗');
        }
        const data = await response.json();

        // 更新顯示的值
        document.getElementById('current_memory_rss').innerText = data.memory_usage.rss;
        document.getElementById('current_memory_vms').innerText = data.memory_usage.vms;
        document.getElementById('current_memory_percent').innerText = data.memory_usage.percent;

        // 更新進度條
        const rssProgress = document.getElementById('rss_progress');
        const vmsProgress = document.getElementById('vms_progress');
        const percentProgress = document.getElementById('percent_progress');

        rssProgress.style.width = `${Math.min(data.memory_usage.percent, 100)}%`;
        vmsProgress.style.width = `${Math.min(data.memory_usage.percent, 100)}%`;
        percentProgress.style.width = `${Math.min(data.memory_usage.percent, 100)}%`;

        // 根據使用率更新進度條顏色
        const colorClass = updateProgressBarColor(data.memory_usage.percent);
        rssProgress.className = `progress-bar ${colorClass}`;
        vmsProgress.className = `progress-bar ${colorClass}`;
        percentProgress.className = `progress-bar ${colorClass}`;

        // 更新時間戳
        const now = new Date();
        document.getElementById('last-update-time').innerText = `最後更新: ${formatTime(now)}`;
      } catch (error) {
        console.error('更新記憶體資訊時發生錯誤:', error);
      }
    }

    // 頁面載入時立即更新一次
    updateMemoryUsage();

    // 每5秒更新一次
    setInterval(updateMemoryUsage, 5000);

    // 表單提交處理
    document.getElementById('upload-form').addEventListener('submit', async function (event) {
      event.preventDefault();

      const fileInput = document.getElementById('file');
      if (fileInput.files.length === 0) {
        alert("請選擇一個檔案進行上傳。");
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      const spinner = document.getElementById('spinner');
      const uploadButton = document.querySelector('button[type="submit"]');

      try {
        spinner.style.display = 'block';
        uploadButton.disabled = true;

        const response = await fetch('/analyze', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || '上傳或分析失敗');
        }

        const data = await response.json();

        // 填充模態框內容
        document.getElementById('prediction').innerText = data.prediction;
        document.getElementById('processing_time').innerText = data.processing_time;
        document.getElementById('original_image').src = data.original_image_url;
        document.getElementById('masked_image').src = data.masked_image_url;

        // 填充處理時的記憶體資訊
        document.getElementById('memory_rss').innerText = data.memory_usage.rss;
        document.getElementById('memory_vms').innerText = data.memory_usage.vms;
        document.getElementById('memory_percent').innerText = data.memory_usage.percent;

        // 顯示模態框
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        resultModal.show();

        // 清空檔案輸入
        fileInput.value = '';

      } catch (error) {
        alert(`錯誤: ${error.message}`);
      } finally {
        spinner.style.display = 'none';
        uploadButton.disabled = false;
      }
    });
  </script>
</body>

</html>